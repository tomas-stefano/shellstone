#!/usr/bin/env bash
# ShellStone CLI for Pharo
# Usage: shellstone-pharo [options]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TMP_DIR="$PROJECT_ROOT/tmp"
PHARO_VERSION="${PHARO_VERSION:-120}"

# Download Pharo if needed
setup_pharo() {
    mkdir -p "$TMP_DIR"
    if [ ! -f "$TMP_DIR/Pharo.image" ]; then
        echo "Downloading Pharo $PHARO_VERSION..."
        cd "$TMP_DIR" && curl -sL "https://get.pharo.org/${PHARO_VERSION}+vm" | bash > /dev/null 2>&1
    fi
}

# Load ShellStone into image
load_shellstone() {
    cd "$TMP_DIR" && ./pharo Pharo.image eval --save \
        "Metacello new baseline: 'ShellStone'; repository: 'tonel://$PROJECT_ROOT/pharo-src'; load." \
        2>&1 | grep -v "^MetacelloNotification" || true
}

# Run specs
run_specs() {
    cd "$TMP_DIR" && ./pharo Pharo.image eval "SSRunner run > 0 ifTrue: [Smalltalk exit: 1]"
}

# Main
case "${1:-run}" in
    run|spec|test)
        setup_pharo
        load_shellstone
        run_specs
        ;;
    setup)
        setup_pharo
        load_shellstone
        echo "Pharo ready at $TMP_DIR"
        ;;
    clean)
        rm -rf "$TMP_DIR"
        echo "Cleaned $TMP_DIR"
        ;;
    help|--help|-h)
        echo "ShellStone CLI for Pharo"
        echo ""
        echo "Usage: shellstone-pharo [command]"
        echo ""
        echo "Commands:"
        echo "  run, spec, test   Run specs (default)"
        echo "  setup             Download Pharo and load ShellStone"
        echo "  clean             Remove tmp directory"
        echo "  help              Show this help"
        echo ""
        echo "Environment:"
        echo "  PHARO_VERSION     Pharo version (default: 120)"
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'shellstone-pharo help' for usage"
        exit 1
        ;;
esac
